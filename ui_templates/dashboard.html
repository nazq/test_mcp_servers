<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: var(--mcp-font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif);
    background: var(--mcp-bg, #0f172a);
    color: var(--mcp-fg, #e2e8f0);
    padding: 16px;
  }
  h2 { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
  .subtitle { font-size: 11px; color: #64748b; margin-bottom: 14px; }
  .status-bar {
    display: flex; align-items: center; gap: 8px; margin-bottom: 16px;
    padding: 6px 10px; background: #1e293b; border-radius: 6px; font-size: 11px;
  }
  .dot { width: 8px; height: 8px; border-radius: 50%; background: #94a3b8; }
  .dot.on { background: #22c55e; animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

  /* Info card */
  .info-card {
    background: linear-gradient(135deg, #1e1b4b, #312e81);
    border-radius: 10px; padding: 16px; margin-bottom: 14px;
    border: 1px solid #4338ca; position: relative; overflow: hidden;
  }
  .info-card::before {
    content: ''; position: absolute; top: -50%; right: -50%;
    width: 100%; height: 200%; background: radial-gradient(circle, rgba(99,102,241,0.1) 0%, transparent 70%);
  }
  .id-row { display: flex; justify-content: space-between; align-items: center; position: relative; }
  .id-label { font-size: 10px; color: #a5b4fc; text-transform: uppercase; letter-spacing: 0.05em; }
  .id-value { font-size: 14px; font-weight: 600; margin-top: 2px; }
  .id-badge {
    display: inline-block; padding: 3px 10px; border-radius: 10px;
    font-size: 10px; font-weight: 600; background: #166534; color: #dcfce7;
  }

  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
  .card {
    background: #1e293b; border-radius: 8px; padding: 12px;
    border: 1px solid #334155;
  }
  .card-label { font-size: 10px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; }
  .card-value { font-size: 22px; font-weight: 700; margin-top: 2px; }
  .card-value.ok { color: #22c55e; }
  .card-delta { font-size: 10px; color: #22c55e; }

  .chart-card { background: #1e293b; border-radius: 8px; padding: 12px; border: 1px solid #334155; }
  .chart-card h3 { font-size: 12px; color: #94a3b8; margin-bottom: 8px; }
  .chart-container { position: relative; height: 160px; }
  .csp-warn {
    padding: 8px 12px; background: #451a03; border: 1px solid #92400e;
    border-radius: 6px; font-size: 11px; color: #fcd34d; margin-bottom: 12px;
    display: none;
  }

  .controls { display: flex; gap: 8px; margin-top: 14px; }
  button {
    flex: 1; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer;
    font-size: 12px; font-weight: 500; transition: all 0.15s ease;
  }
  .btn-primary { background: #4f46e5; color: #fff; }
  .btn-secondary { background: #334155; color: #e2e8f0; }
  button:hover { filter: brightness(1.15); }
  button:disabled { opacity: 0.4; cursor: not-allowed; }
  .log {
    margin-top: 10px; font-size: 10px; color: #64748b;
    max-height: 60px; overflow-y: auto; font-family: monospace;
    background: #0f172a; border-radius: 4px; padding: 6px;
  }
  .log div { padding: 1px 0; }
</style>
</head>
<body>
<h2>MCP Test Server Dashboard</h2>
<div class="subtitle">Interactive metrics &mdash; Chart.js + tool calls via MCP App shim</div>

<div class="csp-warn" id="csp-warn">
  Chart.js failed to load (CSP restriction). Falling back to text mode.
</div>

<div class="status-bar">
  <div class="dot" id="dot"></div>
  <span id="status">Connecting to MCP host...</span>
</div>

<!-- Info card -->
<div class="info-card">
  <div class="id-row" style="margin-bottom:10px">
    <div>
      <div class="id-label">Server</div>
      <div class="id-value" id="id-server">mcp-test-server</div>
    </div>
    <span class="id-badge" id="id-badge">MCP App</span>
  </div>
  <div class="id-row">
    <div>
      <div class="id-label">Server Time</div>
      <div class="id-value" style="font-size:12px" id="id-time">--</div>
    </div>
  </div>
</div>

<div class="grid">
  <div class="card">
    <div class="card-label">Tool Calls</div>
    <div class="card-value ok" id="call-count">0</div>
  </div>
  <div class="card">
    <div class="card-label">Computations</div>
    <div class="card-value" id="comp-count">0</div>
    <div class="card-delta" id="comp-delta"></div>
  </div>
</div>

<div class="chart-card">
  <h3>Computation Results (Add Tool)</h3>
  <div class="chart-container">
    <canvas id="chart"></canvas>
  </div>
  <div id="text-chart" style="display:none; font-family:monospace; font-size:11px; color:#94a3b8;"></div>
</div>

<div class="controls">
  <button class="btn-primary" id="btn-time" disabled>Server Time</button>
  <button class="btn-secondary" id="btn-compute" disabled>Random Add</button>
  <button class="btn-secondary" id="btn-burst" disabled>Burst x5</button>
</div>

<div class="log" id="log"></div>

<script>
// {{MCP_APP_SHIM}}

var app = new McpApp('Dashboard', '1.0.0');
var hasChartJs = typeof Chart !== 'undefined';
var results = [];
var totalCalls = 0;
var lineChart = null;

if (!hasChartJs) {
  document.getElementById('csp-warn').style.display = 'block';
  document.getElementById('chart').style.display = 'none';
  document.getElementById('text-chart').style.display = 'block';
}

function log(msg) {
  var el = document.getElementById('log');
  var d = document.createElement('div');
  d.textContent = new Date().toLocaleTimeString() + ' ' + msg;
  el.insertBefore(d, el.firstChild);
  if (el.children.length > 30) el.removeChild(el.lastChild);
}

function initChart() {
  if (!hasChartJs) return;
  Chart.defaults.color = '#94a3b8';
  Chart.defaults.borderColor = '#334155';
  lineChart = new Chart(document.getElementById('chart'), {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Result',
        data: [],
        borderColor: '#818cf8',
        backgroundColor: 'rgba(129,140,248,0.1)',
        fill: true, tension: 0.3, pointRadius: 3,
        pointBackgroundColor: '#818cf8',
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { display: true, grid: { display: false } },
        y: { display: true, beginAtZero: true }
      }
    }
  });
}

function updateChart() {
  if (hasChartJs && lineChart) {
    lineChart.data.labels = results.map(function(_, i) { return '#' + (i + 1); });
    lineChart.data.datasets[0].data = results;
    lineChart.update('none');
  } else {
    var last8 = results.slice(-8);
    document.getElementById('text-chart').textContent = last8.map(function(v, i) {
      var bar = '';
      for (var j = 0; j < Math.min(v / 5, 40); j++) bar += '\u2588';
      return String(i + 1).padStart(2) + ' | ' + bar + ' ' + v.toFixed(1);
    }).join('\n');
  }
}

function checkTime() {
  document.getElementById('btn-time').disabled = true;
  app.callServerTool('current_time', {}).then(function(r) {
    totalCalls++;
    document.getElementById('call-count').textContent = totalCalls;
    var data = r.content && r.content[0] && r.content[0].text;
    if (data) {
      document.getElementById('id-time').textContent = data;
      log('Time: ' + data);
    }
    document.getElementById('btn-time').disabled = false;
  }).catch(function(e) {
    document.getElementById('btn-time').disabled = false;
    log('Time error: ' + (e.message || e));
  });
}

function doAdd() {
  var a = Math.round(Math.random() * 100 * 10) / 10;
  var b = Math.round(Math.random() * 100 * 10) / 10;
  return app.callServerTool('add', { a: a, b: b }).then(function(r) {
    totalCalls++;
    document.getElementById('call-count').textContent = totalCalls;
    var data = r.content && r.content[0] && r.content[0].text;
    if (data) {
      var val = parseFloat(data);
      if (!isNaN(val)) {
        results.push(val);
        document.getElementById('comp-count').textContent = results.length;
        document.getElementById('comp-delta').textContent = '+' + val.toFixed(1);
        log('Add: ' + a + ' + ' + b + ' = ' + val);
      }
    }
    updateChart();
  });
}

app.connect().then(function() {
  document.getElementById('dot').className = 'dot on';
  document.getElementById('status').textContent = 'Connected to MCP host';
  document.getElementById('btn-time').disabled = false;
  document.getElementById('btn-compute').disabled = false;
  document.getElementById('btn-burst').disabled = false;
  initChart();
  checkTime();
  log('Connected');
}).catch(function(e) {
  document.getElementById('status').textContent = 'Error: ' + (e.message || e);
});

document.getElementById('btn-time').addEventListener('click', checkTime);
document.getElementById('btn-compute').addEventListener('click', function() {
  this.disabled = true;
  var self = this;
  doAdd().finally(function() { self.disabled = false; });
});
document.getElementById('btn-burst').addEventListener('click', function() {
  this.disabled = true;
  var self = this;
  var chain = Promise.resolve();
  for (var i = 0; i < 5; i++) {
    chain = chain.then(function() { return doAdd(); });
  }
  chain.finally(function() { self.disabled = false; });
});
</script>
</body>
</html>
