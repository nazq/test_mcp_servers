name: Release-plz

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  packages: write

env:
  CARGO_TERM_COLOR: always

jobs:
  release-plz:
    name: Release-plz
    runs-on: ubuntu-latest
    concurrency:
      group: release-plz-${{ github.ref }}
      cancel-in-progress: false
    outputs:
      releases_created: ${{ steps.release-plz.outputs.releases_created }}
      releases: ${{ steps.release-plz.outputs.releases }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install release-plz
        uses: taiki-e/install-action@v2
        with:
          tool: release-plz

      - name: Get latest tag
        id: latest-tag
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          if [ -n "$TAG" ]; then
            echo "Found latest tag: $TAG"
            git worktree add ../release-ref "$TAG"
          else
            echo "No tags found"
          fi

      - name: Run release-plz release-pr
        id: release-pr
        run: |
          if [ -n "${{ steps.latest-tag.outputs.tag }}" ]; then
            release-plz release-pr --git-token "$GITHUB_TOKEN" --registry-manifest-path ../release-ref/Cargo.toml || true
          else
            release-plz release-pr --git-token "$GITHUB_TOKEN" || true
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run release-plz release
        id: release-plz
        run: |
          OUTPUT=$(release-plz release --git-token "$GITHUB_TOKEN" -o json 2>&1 | grep -E '^\{' || echo '{"releases":[]}')
          echo "Raw output: $OUTPUT"
          RELEASES=$(echo "$OUTPUT" | jq -c '.releases // []' 2>/dev/null || echo "[]")
          echo "releases=$RELEASES" >> $GITHUB_OUTPUT
          RELEASES_CREATED=$(echo "$RELEASES" | jq 'length > 0' 2>/dev/null || echo "false")
          echo "releases_created=$RELEASES_CREATED" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker:
    name: Publish Docker
    needs: release-plz
    if: needs.release-plz.outputs.releases_created == 'true'
    uses: ./.github/workflows/release.yml
    with:
      tag: ${{ fromJSON(needs.release-plz.outputs.releases)[0].tag }}
    secrets: inherit
