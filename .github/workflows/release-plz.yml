name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # Create/update release PR with changelog and version bumps
  release-pr:
    name: Release PR
    runs-on: ubuntu-latest
    concurrency:
      group: release-plz-${{ github.ref }}
      cancel-in-progress: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Get latest tag
        id: latest-tag
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          if [ -n "$TAG" ]; then
            echo "Found latest tag: $TAG"
          else
            echo "No tags found"
          fi

      - name: Checkout tag for comparison
        if: steps.latest-tag.outputs.tag != ''
        run: |
          git worktree add ../release-ref ${{ steps.latest-tag.outputs.tag }}

      - name: Run release-plz release-pr
        uses: release-plz/action@v0.5
        with:
          command: release-pr
          registry_manifest_path: ${{ steps.latest-tag.outputs.tag != '' && '../release-ref/Cargo.toml' || '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Create GitHub releases for any unpublished versions
  # Only creates a release when Cargo.toml version > latest git tag
  release:
    name: Release
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.release-plz.outputs.releases_created }}
      releases: ${{ steps.release-plz.outputs.releases }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run release-plz release
        id: release-plz
        uses: release-plz/action@v0.5
        with:
          command: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
